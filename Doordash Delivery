** Extremely Late Delivery**

A delivery is flagged as extremely late if its actual delivery time is more than 20 minutes after its predicted delivery time. In each month, what percentage of placed orders were extremely late?
Output the month in a YYYY-MM format and the corresponding proportion of the extremely late orders as the percentage of all orders placed in this month.

--
Data
select * from delivery_orders

delivery_id	order_placed_time	predicted_delivery_time	actual_delivery_time	delivery_rating	dasher_id	restaurant_id	consumer_id
O2132	2021-11-17 04:45:33	2021-11-17 05:37:33	2021-11-17 05:58:33	4	D239	R633	C1001
O2152	2021-12-09 19:09:43	2021-12-09 19:41:43	2021-12-09 19:41:43	3	D238	R635	C1010
O2158	2022-01-04 02:31:19	2022-01-04 02:56:19	2022-01-04 03:21:19	4	D239	R634	C1010
O2173	2022-02-09 00:45:22	2022-02-09 01:19:22	2022-02-09 01:33:22	0	D239	R633	C1038
O2145	2021-12-04 17:20:27	2021-12-04 18:04:27	2021-12-04 18:31:27	1	D239	R634	C1042
O2144	2021-12-04 12:50:49	2021-12-04 13:34:49	2021-12-04 13:47:49	1	D238	R637	C1059
O2172	2022-02-08 14:53:35	2022-02-08 15:13:35	2022-02-08 15:24:35	5	D237	R636	C1059
O2170	2022-02-04 03:08:23	2022-02-04 03:28:23	2022-02-04 03:26:23	1	D239	R636	C1083
O2150	2021-12-08 10:47:50	2021-12-08 11:27:50	2021-12-08 11:25:50	3	D240	R631	C1130
O2177	2022-02-26 15:26:49	2022-02-26 16:12:49	2022-02-26 16:24:49	0	D240	R637	C1170
O2129	2021-11-07 06:45:08	2021-11-07 07:18:08	2021-11-07 07:21:08	3	D240	R631	C1199
O2147	2021-12-05 14:24:51	2021-12-05 15:07:51	2021-12-05 15:11:51	3	D238	R631	C1252
O2149	2021-12-08 08:10:38	2021-12-08 08:39:38	2021-12-08 08:44:38	0	D240	R631	C1261
O2135	2021-11-23 17:57:38	2021-11-23 18:16:38	2021-11-23 18:47:38	0	D238	R636	C1264
O2139	2021-11-30 18:31:01	2021-11-30 19:29:01	2021-11-30 20:22:01	4	D241	R633	C1291
O2157	2022-01-03 20:27:01	2022-01-03 21:10:01	2022-01-03 21:18:01	3	D241	R632	C1315
O2167	2022-01-31 23:04:45	2022-01-31 23:57:45	2022-02-01 00:11:45	1	D239	R633	C1331
O2153	2021-12-11 01:20:57	2021-12-11 02:10:57	2021-12-11 02:06:57	4	D240	R631	C1343
O2148	2021-12-06 09:13:12	2021-12-06 10:12:12	2021-12-06 10:14:12	5	D238	R633	C1377
O2137	2021-11-28 10:44:47	2021-11-28 11:08:47	2021-11-28 11:22:47	3	D239	R632	C1395
O2131	2021-11-15 22:56:56	2021-11-15 23:35:56	2021-11-15 23:45:56	4	D237	R631	C1413
O2162	2022-01-20 14:46:04	2022-01-20 15:12:04	2022-01-20 15:34:04	1	D239	R635	C1423
O2143	2021-12-04 08:31:37	2021-12-04 08:53:37	2021-12-04 08:53:37	2	D238	R632	C1428
O2138	2021-11-29 06:33:35	2021-11-29 07:32:35	2021-11-29 07:31:35	5	D241	R637	C1434
O2174	2022-02-15 15:37:10	2022-02-15 16:19:10	2022-02-15 16:33:10	0	D239	R635	C1447
O2151	2021-12-08 23:51:43	2021-12-09 00:33:43	2021-12-09 00:30:43	2	D241	R631	C1472
O2142	2021-12-04 01:17:59	2021-12-04 01:36:59	2021-12-04 01:45:59	3	D237	R632	C1478
O2141	2021-12-01 02:33:28	2021-12-01 03:08:28	2021-12-01 03:05:28	2	D240	R637	C1516
O2166	2022-01-29 16:23:41	2022-01-29 17:13:41	2022-01-29 17:18:41	4	D240	R631	C1524
O2161	2022-01-17 15:47:17	2022-01-17 16:47:17	2022-01-17 17:00:17	5	D238	R633	C1529
O2164	2022-01-26 15:58:42	2022-01-26 16:41:42	2022-01-26 16:58:42	3	D240	R633	C1551
O2175	2022-02-20 15:05:53	2022-02-20 15:27:53	2022-02-20 15:33:53	0	D240	R635	C1553
O2176	2022-02-25 04:03:45	2022-02-25 04:18:45	2022-02-25 04:21:45	5	D241	R634	C1558
O2156	2021-12-28 09:18:08	2021-12-28 09:55:08	2021-12-28 10:08:08	3	D240	R633	C1615
O2168	2022-02-01 13:59:36	2022-02-01 14:19:36	2022-02-01 14:31:36	3	D239	R635	C1631
O2163	2022-01-26 10:04:30	2022-01-26 10:27:30	2022-01-26 10:49:30	0	D240	R634	C1656
O2134	2021-11-20 19:59:52	2021-11-20 20:54:52	2021-11-20 20:49:52	1	D241	R633	C1665
O2136	2021-11-27 23:13:44	2021-11-28 00:04:44	2021-11-28 00:05:44	3	D237	R636	C1676
O2171	2022-02-07 00:21:38	2022-02-07 01:17:38	2022-02-07 01:46:38	0	D241	R636	C1683
O2159	2022-01-11 22:28:59	2022-01-11 22:45:59	2022-01-11 23:16:59	3	D238	R635	C1708
O2155	2021-12-16 16:26:15	2021-12-16 16:48:15	2021-12-16 17:11:15	3	D239	R636	C1721
O2130	2021-11-12 02:07:10	2021-11-12 02:31:10	2021-11-12 02:56:10	5	D241	R632	C1744
O2160	2022-01-15 14:43:27	2022-01-15 15:41:27	2022-01-15 15:46:27	3	D241	R636	C1748
O2128	2021-11-06 09:42:00	2021-11-06 10:19:00	2021-11-06 10:20:00	0	D241	R632	C1764
O2133	2021-11-20 12:37:51	2021-11-20 13:08:51	2021-11-20 13:26:51	0	D240	R635	C1776
O2154	2021-12-12 23:55:56	2021-12-13 00:11:56	2021-12-13 00:12:56	4	D240	R633	C1801
O2140	2021-11-30 23:36:09	2021-12-01 00:03:09	2021-12-01 00:07:09	1	D238	R632	C1853
O2169	2022-02-03 01:02:59	2022-02-03 01:51:59	2022-02-03 01:53:59	1	D240	R637	C1929
O2165	2022-01-27 14:37:57	2022-01-27 15:33:57	2022-01-27 15:36:57	4	D237	R636	C1940
O2146	2021-12-04 22:55:54	2021-12-04 23:30:54	2021-12-04 23:26:54	4	D240	R633	C1970

--
Solution

select
year_month,
late_orders,
num_orders,
late_orders*1.0/num_orders as percent_late_orders
from
(
select
to_char(actual_delivery_time,'YYYY-MM') as year_month,
count(*) as num_orders, 
sum(case when (actual_delivery_time - predicted_delivery_time) > interval '20 minutes' then 1 else 0 end) as late_orders
from delivery_orders
group by 1
) a
